<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary: #5b4fd6;
  --primary-light: #6b5ce7;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --dark: #1e293b;
  --light: #f8fafc;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}

html {
  font-size: 14px;
}

body {
  font-family: 'Cairo', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 12px;
  direction: rtl;
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.container {
  max-width: 480px;
  margin: 0 auto;
  width: 100%;
}

.header {
  text-align: center;
  color: white;
  margin-bottom: 12px;
}

.header h1 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.header p {
  opacity: 0.9;
  font-size: 0.75rem;
}

.card {
  background: white;
  border-radius: 20px;
  padding: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  margin-bottom: 12px;
}

.stats-bar {
  display: flex;
  justify-content: center;
  padding: 12px;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-radius: 12px;
  margin-bottom: 16px;
  border: 1px solid #bae6fd;
}

.stat-value {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--primary);
  line-height: 1;
}

.stat-label {
  color: #64748b;
  font-size: 12px;
  font-weight: 600;
  margin-top: 2px;
}

.search-section {
  position: relative;
  margin-bottom: 16px;
}

.search-box {
  display: flex;
  gap: 8px;
  align-items: stretch;
}

.search-input {
  flex: 1;
  padding: 10px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 13px;
  font-family: 'Cairo', sans-serif;
  transition: all 0.2s;
  background: #f8fafc;
  height: 42px;
}

.search-input:focus {
  outline: none;
  border-color: var(--primary);
  background: white;
}

.search-btn {
  padding: 10px 20px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.search-btn:hover {
  background: var(--primary-light);
  transform: translateY(-1px);
}

.suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
  margin-top: 5px;
  border: 1px solid #e2e8f0;
}

.suggestions.active {
  display: block;
}

.suggestion-item {
  padding: 10px 12px;
  cursor: pointer;
  border-bottom: 1px solid #f1f5f9;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.suggestion-item:hover {
  background: #f8fafc;
}

.suggestion-item .avatar {
  width: 28px;
  height: 28px;
  background: var(--primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 11px;
  flex-shrink: 0;
}

.suggestion-item .info {
  flex: 1;
  min-width: 0;
}

.suggestion-item .name {
  font-weight: 600;
  color: var(--dark);
  font-size: 12px;
  margin-bottom: 1px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.suggestion-item .details {
  font-size: 10px;
  color: #64748b;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.suggestion-item .major-tag {
  background: var(--primary);
  color: white;
  padding: 1px 5px;
  border-radius: 8px;
  font-size: 9px;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 12px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  font-weight: 600;
  color: var(--dark);
  font-size: 11px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.form-group input,
.form-group select {
  padding: 8px 10px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 12px;
  font-family: 'Cairo', sans-serif;
  transition: all 0.2s;
  background: #f8fafc;
  width: 100%;
  height: 38px;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--primary);
  background: white;
}

.form-group input:read-only {
  background: #e2e8f0;
  cursor: not-allowed;
}

.points-section {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 12px;
  border: 1px solid #bae6fd;
}

.points-display {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.points-number {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--primary);
  line-height: 1;
}

.points-label {
  color: #64748b;
  font-size: 11px;
  font-weight: 600;
  margin-top: 2px;
}

.points-input-group {
  display: flex;
  gap: 8px;
}

.points-input {
  flex: 1;
  padding: 8px 10px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  text-align: center;
  font-size: 13px;
  font-weight: 600;
  height: 38px;
}

.btn-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.btn {
  padding: 10px 14px;
  border: none;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  white-space: nowrap;
  height: 40px;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-light);
  transform: translateY(-1px);
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-success:hover {
  background: #059669;
  transform: translateY(-1px);
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-danger:hover {
  background: #dc2626;
  transform: translateY(-1px);
}

.btn-warning {
  background: var(--warning);
  color: white;
  height: 38px;
}

.btn-warning:hover {
  background: #d97706;
  transform: translateY(-1px);
}

.btn-secondary {
  background: #6b7280;
  color: white;
}

.btn-secondary:hover {
  background: #4b5563;
  transform: translateY(-1px);
}

.message {
  padding: 10px 12px;
  border-radius: 8px;
  margin-bottom: 12px;
  display: none;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  font-size: 12px;
}

.message.show {
  display: flex;
  animation: slideIn 0.3s ease;
}

.message.success {
  background: #d1fae5;
  color: #065f46;
  border: 1px solid #a7f3d0;
}

.message.error {
  background: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.message.info {
  background: #dbeafe;
  color: #1e40af;
  border: 1px solid #bfdbfe;
}

/* Custom Modal Styles for WebView Compatibility */
.custom-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  padding: 16px;
}

.custom-modal.active {
  opacity: 1;
  visibility: visible;
}

.custom-modal-content {
  background: white;
  border-radius: 16px;
  padding: 20px;
  max-width: 300px;
  width: 100%;
  text-align: center;
  transform: scale(0.9);
  transition: transform 0.3s ease;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.custom-modal.active .custom-modal-content {
  transform: scale(1);
}

.custom-modal-icon {
  font-size: 40px;
  margin-bottom: 8px;
}

.custom-modal-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 6px;
}

.custom-modal-text {
  font-size: 13px;
  color: #64748b;
  margin-bottom: 16px;
  line-height: 1.5;
}

.custom-modal-buttons {
  display: flex;
  gap: 8px;
}

.custom-modal-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.custom-modal-btn.cancel {
  background: #f1f5f9;
  color: #64748b;
}

.custom-modal-btn.cancel:hover {
  background: #e2e8f0;
}

.custom-modal-btn.confirm {
  background: var(--danger);
  color: white;
}

.custom-modal-btn.confirm:hover {
  background: #dc2626;
}

.custom-modal-btn.confirm.success {
  background: var(--success);
}

.custom-modal-btn.confirm.success:hover {
  background: #059669;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Large screens - maintain compact size */
@media (min-width: 481px) {
  html {
    font-size: 15px;
  }
  
  .container {
    max-width: 480px;
  }
  
  .card {
    padding: 18px;
  }
}

/* Small screens */
@media (max-width: 360px) {
  html {
    font-size: 13px;
  }
  
  body {
    padding: 8px;
  }
  
  .card {
    padding: 12px;
    border-radius: 16px;
  }
  
  .form-grid {
    gap: 8px;
  }
  
  .btn-group {
    gap: 6px;
  }
  
  .btn {
    padding: 8px 10px;
    font-size: 11px;
    height: 36px;
  }
  
  .search-btn {
    padding: 8px 14px;
    height: 38px;
  }
  
  .search-input {
    height: 38px;
  }
}

/* Prevent zoom on iOS inputs */
@media screen and (-webkit-min-device-pixel-ratio: 0) { 
  select,
  textarea,
  input {
    font-size: 16px;
  }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ğŸ“</h1>
    <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ø§Ø·</p>
  </div>

  <div class="card">
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="totalStudents">0</div>
        <div class="stat-label">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
      </div>
    </div>

    <div id="message" class="message"></div>

    <div class="search-section">
      <div class="search-box">
        <input 
          type="text" 
          id="searchInput" 
          class="search-input" 
          placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." 
          autocomplete="off"
          oninput="handleSearchInput(this.value)"
        />
        <button class="search-btn" onclick="searchStudent()">Ø¨Ø­Ø«</button>
      </div>
      <div id="suggestions" class="suggestions"></div>
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label>ğŸ“‹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</label>
        <input type="text" id="studentId" placeholder="Ø§Ù„Ø±Ù‚Ù…" />
      </div>
      
      <div class="form-group">
        <label>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</label>
        <input type="text" id="studentName" placeholder="Ø§Ù„Ø§Ø³Ù…" />
      </div>
      
      <div class="form-group">
        <label>ğŸ“Š Ø§Ù„Ù†Ø³Ø¨Ø©</label>
        <input type="text" id="studentGrade" placeholder="95%" oninput="formatGrade(this)" />
      </div>
      
      <div class="form-group">
        <label>ğŸ¯ Ø§Ù„ØªØ®ØµØµ</label>
        <select id="studentMajor">
          <option value="">Ø§Ø®ØªØ±...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>ğŸ“± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
        <input type="text" id="studentWhatsapp" placeholder="055xxxxxxx" />
      </div>
      
      <div class="form-group">
        <label>ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="text" id="studentPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>
    </div>

    <div class="points-section">
      <div class="points-display">
        <div>
          <div class="points-label">Ø§Ù„Ù†Ù‚Ø§Ø·</div>
          <div class="points-number" id="currentPoints">0</div>
        </div>
        <div style="font-size: 1.75rem;">â­</div>
      </div>
      <div class="points-input-group">
        <input 
          type="number" 
          id="pointsChange" 
          class="points-input" 
          placeholder="+/-"
        />
        <button class="btn btn-warning" onclick="updatePoints()">
          âš¡ ØªØ¹Ø¯ÙŠÙ„
        </button>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-success" onclick="addStudent()">
        â• Ø¥Ø¶Ø§ÙØ©
      </button>
      <button class="btn btn-primary" onclick="saveStudent()">
        ğŸ’¾ Ø­ÙØ¸
      </button>
      <button class="btn btn-danger" onclick="deleteStudent()">
        ğŸ—‘ï¸ Ø­Ø°Ù
      </button>
      <button class="btn btn-secondary" onclick="clearForm()">
        ğŸ”„ Ø¬Ø¯ÙŠØ¯
      </button>
    </div>
  </div>
</div>

<!-- Custom Modal for WebView Compatibility -->
<div id="customModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-icon" id="modalIcon">âš ï¸</div>
    <div class="custom-modal-title" id="modalTitle">ØªØ£ÙƒÙŠØ¯</div>
    <div class="custom-modal-text" id="modalText">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</div>
    <div class="custom-modal-buttons">
      <button class="custom-modal-btn cancel" id="modalCancel" onclick="closeModal(false)">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="custom-modal-btn confirm" id="modalConfirm" onclick="closeModal(true)">ØªØ£ÙƒÙŠØ¯</button>
    </div>
  </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyAEXAMPLEnY", 
  authDomain: "store-points-7d2f4.firebaseapp.com",
  databaseURL: "https://store-points-7d2f4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "store-points-7d2f4",
  storageBucket: "store-points-7d2f4.appspot.com",
  messagingSenderId: "105011111111",
  appId: "1:105011111111:web:abc123example"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let allStudents = [];
let currentStudent = null;
let availableMajors = [];
let modalResolve = null;

// Load all students and majors on startup
window.onload = function() {
  loadAllStudents();
  loadMajors();
};

function loadAllStudents() {
  db.ref('users').on('value', (snapshot) => {
    const data = snapshot.val() || {};
    allStudents = Object.entries(data).map(([id, student]) => ({
      id,
      ...student
    }));
    updateStats();
  });
}

function loadMajors() {
  db.ref('users').once('value', (snapshot) => {
    const data = snapshot.val() || {};
    const majorsSet = new Set();
    
    Object.values(data).forEach(student => {
      if (student.major && student.major.trim() !== '') {
        majorsSet.add(student.major.trim());
      }
    });
    
    availableMajors = Array.from(majorsSet).sort();
    populateMajorsSelect();
  });
}

function populateMajorsSelect() {
  const select = document.getElementById('studentMajor');
  select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ</option>';
  
  availableMajors.forEach(major => {
    const option = document.createElement('option');
    option.value = major;
    option.textContent = major;
    select.appendChild(option);
  });
  
  const newOption = document.createElement('option');
  newOption.value = "__new__";
  newOption.textContent = "+ ØªØ®ØµØµ Ø¬Ø¯ÙŠØ¯";
  select.appendChild(newOption);
  
  select.onchange = function() {
    if (this.value === "__new__") {
      showModal('newMajor', 'ØªØ®ØµØµ Ø¬Ø¯ÙŠØ¯', 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØ®ØµØµ:', 'Ø¥Ù„ØºØ§Ø¡', 'Ø¥Ø¶Ø§ÙØ©').then(result => {
        if (result && result.value) {
          const newMajor = result.value.trim();
          if (newMajor && !availableMajors.includes(newMajor)) {
            availableMajors.push(newMajor);
            availableMajors.sort();
            populateMajorsSelect();
            setTimeout(() => {
              document.getElementById('studentMajor').value = newMajor;
            }, 100);
          }
        }
      });
      this.value = "";
    }
  };
}

function updateStats() {
  document.getElementById('totalStudents').textContent = allStudents.length;
}

function showMessage(text, type = 'info') {
  const msgEl = document.getElementById('message');
  msgEl.innerHTML = text;
  msgEl.className = `message ${type} show`;
  setTimeout(() => {
    msgEl.classList.remove('show');
  }, 3000);
}

// Custom Modal System for WebView Compatibility
function showModal(type, title, text, cancelText = 'Ø¥Ù„ØºØ§Ø¡', confirmText = 'ØªØ£ÙƒÙŠØ¯', input = false) {
  return new Promise((resolve) => {
    modalResolve = resolve;
    const modal = document.getElementById('customModal');
    const icon = document.getElementById('modalIcon');
    const titleEl = document.getElementById('modalTitle');
    const textEl = document.getElementById('modalText');
    const cancelBtn = document.getElementById('modalCancel');
    const confirmBtn = document.getElementById('modalConfirm');
    
    // Set content
    titleEl.textContent = title;
    textEl.textContent = text;
    cancelBtn.textContent = cancelText;
    confirmBtn.textContent = confirmText;
    
    // Set icon based on type
    if (type === 'delete') {
      icon.textContent = 'ğŸ—‘ï¸';
      confirmBtn.className = 'custom-modal-btn confirm';
    } else if (type === 'success') {
      icon.textContent = 'âœ…';
      confirmBtn.className = 'custom-modal-btn confirm success';
    } else if (type === 'warning') {
      icon.textContent = 'âš ï¸';
      confirmBtn.className = 'custom-modal-btn confirm';
    } else if (type === 'newMajor') {
      icon.textContent = 'ğŸ¯';
      confirmBtn.className = 'custom-modal-btn confirm success';
    } else {
      icon.textContent = 'â“';
      confirmBtn.className = 'custom-modal-btn confirm';
    }
    
    // Add input if needed
    if (input || type === 'newMajor') {
      if (!document.getElementById('modalInput')) {
        const inputEl = document.createElement('input');
        inputEl.type = 'text';
        inputEl.id = 'modalInput';
        inputEl.style.cssText = 'width:100%;padding:8px;margin:8px 0;border:2px solid #e2e8f0;border-radius:8px;font-family:Cairo;font-size:14px;';
        textEl.appendChild(inputEl);
        setTimeout(() => inputEl.focus(), 100);
      }
    } else {
      const existingInput = document.getElementById('modalInput');
      if (existingInput) existingInput.remove();
    }
    
    modal.classList.add('active');
    
    // Handle back button on mobile
    history.pushState({modal: true}, '');
  });
}

function closeModal(confirmed) {
  const modal = document.getElementById('customModal');
  const inputEl = document.getElementById('modalInput');
  let result = confirmed;
  
  if (inputEl && confirmed) {
    result = { confirmed: true, value: inputEl.value };
  }
  
  modal.classList.remove('active');
  if (inputEl) inputEl.remove();
  
  if (modalResolve) {
    modalResolve(result);
    modalResolve = null;
  }
  
  // Handle back button
  if (history.state && history.state.modal) {
    history.back();
  }
}

// Close modal on backdrop click
document.getElementById('customModal').addEventListener('click', (e) => {
  if (e.target.id === 'customModal') {
    closeModal(false);
  }
});

// Handle escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.getElementById('customModal').classList.contains('active')) {
    closeModal(false);
  }
});

function handleSearchInput(value) {
  const suggestionsEl = document.getElementById('suggestions');
  
  if (value.length < 2) {
    suggestionsEl.classList.remove('active');
    return;
  }
  
  const searchTerm = value.toLowerCase();
  const matches = allStudents.filter(student => 
    student.name && student.name.toLowerCase().includes(searchTerm)
  ).slice(0, 8);
  
  if (matches.length === 0) {
    suggestionsEl.innerHTML = '<div class="suggestion-item"><div class="info"><div class="name">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div></div></div>';
    suggestionsEl.classList.add('active');
    return;
  }
  
  suggestionsEl.innerHTML = matches.map(student => `
    <div class="suggestion-item" onclick="selectStudent('${student.id}')">
      <div class="avatar">${student.name.charAt(0)}</div>
      <div class="info">
        <div class="name">${highlightMatch(student.name, value)}</div>
        <div class="details">
          <span>${student.id}</span>
          <span>â­ ${student.points || 0}</span>
          ${student.major ? `<span class="major-tag">${student.major}</span>` : ''}
        </div>
      </div>
    </div>
  `).join('');
  
  suggestionsEl.classList.add('active');
}

function highlightMatch(text, query) {
  const regex = new RegExp(`(${query})`, 'gi');
  return text.replace(regex, '<span style="color: var(--primary); font-weight: bold;">$1</span>');
}

function selectStudent(id) {
  document.getElementById('suggestions').classList.remove('active');
  document.getElementById('searchInput').value = '';
  
  const student = allStudents.find(s => s.id === id);
  if (student) {
    fillForm(student);
    showMessage(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„: ${student.name}`, 'success');
  }
}

function fillForm(student) {
  currentStudent = student;
  document.getElementById('studentId').value = student.id;
  document.getElementById('studentName').value = student.name || '';
  document.getElementById('studentGrade').value = student.grade || '';
  
  if (student.major && !availableMajors.includes(student.major)) {
    availableMajors.push(student.major);
    availableMajors.sort();
    populateMajorsSelect();
  }
  
  document.getElementById('studentMajor').value = student.major || '';
  document.getElementById('studentWhatsapp').value = student.whatsappLink || '';
  document.getElementById('studentPassword').value = student.password || '';
  document.getElementById('currentPoints').textContent = student.points || 0;
  document.getElementById('studentId').readOnly = true;
}

function searchStudent() {
  const searchValue = document.getElementById('searchInput').value.trim();
  if (!searchValue) {
    showMessage('âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¨Ø­Ø«', 'error');
    return;
  }
  
  const byId = allStudents.find(s => s.id === searchValue);
  if (byId) {
    selectStudent(byId.id);
    return;
  }
  
  const byName = allStudents.find(s => 
    s.name && s.name.toLowerCase().includes(searchValue.toLowerCase())
  );
  
  if (byName) {
    selectStudent(byName.id);
  } else {
    showMessage('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');
  }
}

function formatGrade(input) {
  let value = input.value.replace('%', '').trim();
  if (value && !value.endsWith('%')) {
    input.value = value + '%';
  }
}

function addStudent() {
  const id = document.getElementById('studentId').value.trim();
  const name = document.getElementById('studentName').value.trim();
  
  if (!id || !name) {
    showMessage('âš ï¸ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨Ø§Ù†', 'error');
    return;
  }
  
  if (allStudents.some(s => s.id === id)) {
    showMessage('âš ï¸ Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'error');
    return;
  }
  
  const studentData = {
    name: name,
    grade: document.getElementById('studentGrade').value,
    major: document.getElementById('studentMajor').value,
    whatsappLink: document.getElementById('studentWhatsapp').value,
    password: document.getElementById('studentPassword').value,
    points: 0,
    createdAt: new Date().toISOString()
  };
  
  db.ref('users/' + id).set(studentData)
    .then(() => {
      if (studentData.major && !availableMajors.includes(studentData.major)) {
        availableMajors.push(studentData.major);
        availableMajors.sort();
        populateMajorsSelect();
      }
      showMessage('âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
      clearForm();
    })
    .catch(err => {
      showMessage('âŒ Ø®Ø·Ø£: ' + err.message, 'error');
    });
}

function saveStudent() {
  const id = document.getElementById('studentId').value.trim();
  if (!id || !currentStudent) {
    showMessage('âš ï¸ Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', 'error');
    return;
  }
  
  const newMajor = document.getElementById('studentMajor').value;
  
  const updates = {
    name: document.getElementById('studentName').value,
    grade: document.getElementById('studentGrade').value,
    major: newMajor,
    whatsappLink: document.getElementById('studentWhatsapp').value,
    password: document.getElementById('studentPassword').value,
    updatedAt: new Date().toISOString()
  };
  
  db.ref('users/' + id).update(updates)
    .then(() => {
      if (newMajor && !availableMajors.includes(newMajor)) {
        availableMajors.push(newMajor);
        availableMajors.sort();
        populateMajorsSelect();
      }
      showMessage('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    })
    .catch(err => {
      showMessage('âŒ Ø®Ø·Ø£: ' + err.message, 'error');
    });
}

function updatePoints() {
  const id = document.getElementById('studentId').value.trim();
  const pointsInput = document.getElementById('pointsChange').value;
  
  if (!id) {
    showMessage('âš ï¸ Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹', 'error');
    return;
  }
  
  if (!pointsInput || isNaN(pointsInput)) {
    showMessage('âš ï¸ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­', 'error');
    return;
  }
  
  const pointsToAdd = parseInt(pointsInput);
  const currentPoints = parseInt(document.getElementById('currentPoints').textContent) || 0;
  const newPoints = currentPoints + pointsToAdd;
  
  if (newPoints < 0) {
    showMessage('âš ï¸ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø©', 'error');
    return;
  }
  
  db.ref('users/' + id).update({ points: newPoints })
    .then(() => {
      document.getElementById('currentPoints').textContent = newPoints;
      document.getElementById('pointsChange').value = '';
      const action = pointsToAdd > 0 ? 'Ø¥Ø¶Ø§ÙØ©' : 'Ø®ØµÙ…';
      showMessage(`âœ… ØªÙ… ${action} ${Math.abs(pointsToAdd)} Ù†Ù‚Ø·Ø©`, 'success');
    })
    .catch(err => {
      showMessage('âŒ Ø®Ø·Ø£: ' + err.message, 'error');
    });
}

async function deleteStudent() {
  const id = document.getElementById('studentId').value.trim();
  if (!id) {
    showMessage('âš ï¸ Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù„Ù„Ø­Ø°Ù', 'error');
    return;
  }
  
  const confirmed = await showModal(
    'delete', 
    'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', 
    'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!',
    'Ø¥Ù„ØºØ§Ø¡',
    'Ø­Ø°Ù'
  );
  
  if (!confirmed) return;
  
  db.ref('users/' + id).remove()
    .then(() => {
      showMessage('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
      clearForm();
    })
    .catch(err => {
      showMessage('âŒ Ø®Ø·Ø£: ' + err.message, 'error');
    });
}

function clearForm() {
  currentStudent = null;
  document.getElementById('studentId').value = '';
  document.getElementById('studentId').readOnly = false;
  document.getElementById('studentName').value = '';
  document.getElementById('studentGrade').value = '';
  document.getElementById('studentMajor').value = '';
  document.getElementById('studentWhatsapp').value = '';
  document.getElementById('studentPassword').value = '';
  document.getElementById('currentPoints').textContent = '0';
  document.getElementById('pointsChange').value = '';
  document.getElementById('searchInput').value = '';
  document.getElementById('suggestions').classList.remove('active');
}

// Close suggestions on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('.search-section')) {
    document.getElementById('suggestions').classList.remove('active');
  }
});
</script>

</body>
</html>
